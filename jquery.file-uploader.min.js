
/*!
 * jQuery Ajax Easy File Uploader MK2
 * http://jquery.com/
 *
 * Copyright 2016 Júlio César <talk@juliocesar.me>
 * Released under the MIT license
 * http://jquery.org/license
 *
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery","jquery.ui.widget"],a)}else{a(window.jQuery)}}(function(a){a.widget("jFramework.fileuploader",{options:{url:null,dropzone:null,autoUpload:true,acceptablefileExtensionsRegex:/(gif|jpe?g|png)$/i,acceptablefileExtensionsReadable:"gif, jpeg, jpg or png",maxFileSize:2*1024*1024,maxWidth:0,maxHeight:0,limitConcurrentUploadRequests:5,queueInterval:10,messages:{fileTooBigSize:"File %s is too big, Send files smaller than %dMB!",fileTypeNotAllowed:"File %s type is %s and is not allowed!, Send only %s!",fileTooBigWidth:"File %s is too big, Send images equal or lower than %d pixels of width!",fileTooBigHeight:"File %s is too big, Send images equal or lower than %d pixels of height!"}},_totalSize:0,_totalSentSize:0,_totalPercentage:0,_fileInputSupport:!(new RegExp("(Android (1\\.[0156]|2\\.[01]))|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)|(w(eb)?OSBrowser)|(webOS)|(Kindle/(1\\.0|2\\.[05]|3\\.0))").test(window.navigator.userAgent)||a('<input type="file">').prop("disabled")),_format:function(){var g=/%%|%(\d+\$)?([\-+\'#0 ]*)(\*\d+\$|\*|\d+)?(?:\.(\*\d+\$|\*|\d+))?([scboxXuideEfFgG])/g;var h=arguments;var f=0;var k=arguments[f++];var b=function(o,i,l,n){if(!l){l=" "}var m=(o.length>=i)?"":new Array(1+i-o.length>>>0).join(l);return n?o+m:m+o};var c=function(n,m,q,i,l,p){var o=i-n.length;if(o>0){if(q||!l){n=b(n,i,p,q)}else{n=n.slice(0,m.length)+b("",o,"0",true)+n.slice(m.length)}}return n};var j=function(q,p,o,r,l,i,n){var m=q>>>0;o=(o&&m&&{"2":"0b","8":"0","16":"0x"}[p])||"";q=o+b(m.toString(p),i||0,"0",false);return c(q,o,r,l,n)};var e=function(n,p,l,i,m,o){if(i!==null&&i!==undefined){n=n.slice(0,i)}return c(n,"",p,l,m,o)};var d=function(A,n,o,s,x,m){var i,w,l,B,u;if(A==="%%"){return"%"}var t=false;var p="";var r=false;var z=false;var y=" ";var q=o.length;var v;for(v=0;o&&v<q;v++){switch(o.charAt(v)){case" ":p=" ";break;case"+":p="+";break;case"-":t=true;break;case"'":y=o.charAt(v+1);break;case"0":r=true;y="0";break;case"#":z=true;break}}if(!s){s=0}else{if(s==="*"){s=+h[f++]}else{if(s.charAt(0)==="*"){s=+h[s.slice(1,-1)]}else{s=+s}}}if(s<0){s=-s;t=true}if(!isFinite(s)){throw new Error("sprintf: (minimum-)width must be finite")}if(!x){x="fFeE".indexOf(m)>-1?6:(m==="d")?0:undefined}else{if(x==="*"){x=+h[f++]}else{if(x.charAt(0)==="*"){x=+h[x.slice(1,-1)]}else{x=+x}}}u=n?h[n.slice(0,-1)]:h[f++];switch(m){case"s":return e(String(u),t,s,x,r,y);case"c":return e(String.fromCharCode(+u),t,s,x,r);case"b":return j(u,2,z,t,s,x,r);case"o":return j(u,8,z,t,s,x,r);case"x":return j(u,16,z,t,s,x,r);case"X":return j(u,16,z,t,s,x,r).toUpperCase();case"u":return j(u,10,z,t,s,x,r);case"i":case"d":i=+u||0;i=Math.round(i-i%1);w=i<0?"-":p;u=w+b(String(Math.abs(i)),x,"0",false);return c(u,w,t,s,r);case"e":case"E":case"f":case"F":case"g":case"G":i=+u;w=i<0?"-":p;l=["toExponential","toFixed","toPrecision"]["efg".indexOf(m.toLowerCase())];B=["toString","toUpperCase"]["eEfFgG".indexOf(m)%2];u=w+Math.abs(i)[l](x);return c(u,w,t,s,r)[B]();default:return A}};return k.replace(g,d)},_validate:function(c){var b=this;a.each(c,function(f,g){if(g.size>b.options.maxFileSize){var e=b._format(b.options.messages.fileTooBigSize,g.name,(b.options.maxFileSize/1024/1024));b._trigger("file_add",null,{file:g,error:e})}else{g.extension=g.name.split(".").pop();if(!b.options.acceptablefileExtensionsRegex.test(g.extension)){var e=b._format(b.options.messages.fileTypeNotAllowed,g.name,g.extension,b.options.acceptablefileExtensionsReadable);b._trigger("file_add",null,{file:g,error:e})}else{if(b.options.maxWidth>0||b.options.maxHeight>0){var d=new Image();d.onload=function(){var i=b.width;var h=b.height;b._imageCheck(b,g,i,h)};d.src=b._url.createObjectURL(g)}else{b._addFileToQueue(g)}}}})},_imageCheck:function(f,d,e,b){if(f.options.maxWidth>0&&f.options.maxHeight>0){if(e>f.options.maxWidth){var c=f._format(f.options.messages.fileTooBigWidth,d.name,f.options.maxWidth);f._trigger("file_add",null,{file:d,error:c})}else{if(b>f.options.maxHeight){var c=f._format(f.options.messages.fileTooBigHeight,d.name,f.options.maxHeight);f._trigger("file_add",null,{file:d,error:c})}else{f._addFileToQueue(d)}}}else{if(f.options.maxWidth>0){var c=f._format(f.options.messages.fileTooBigWidth,d.name,f.options.maxWidth);f._trigger("file_add",null,{file:d,error:c})}else{if(f.options.maxHeight>0){var c=f._format(f.options.messages.fileTooBigHeight,d.name,f.options.maxHeight);f._trigger("file_add",null,{file:d,error:c})}else{f._addFileToQueue(d)}}}},_getGUID:function(){var c=new Date().getTime();if(window.performance&&typeof window.performance.now==="function"){c+=performance.now()}var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=(c+Math.random()*16)%16|0;c=Math.floor(c/16);return(e=="x"?d:(d&3|8)).toString(16)});return b},_sum:function(b,c){var d=0;a.each(b,function(e,f){d+=parseInt(f[c])});return d},_uploadFile:function(b){this._trigger("file_upload_started",null,{file:b});this.queueUploading[b.uid]=b;var d=this;var c=new FormData();c.append("file",b.file,b.file.name);a.ajax({url:this.options.url,dataType:"json",method:"POST",data:c,cache:false,enctype:"multipart/form-data",contentType:false,processData:false,xhr:function(){var e;if(window.XMLHttpRequest){e=new XMLHttpRequest()}else{e=new ActiveXObject("Microsoft.XMLHTTP")}d.queueUploading[b.uid].xhr=e;e.addEventListener("loadend",function(){d.queueUploading[b.uid].completed=true;d.queueCompleted[b.uid]=d.queueUploading[b.uid];d.queueUploading[b.uid]=undefined;delete d.queueUploading[b.uid];d.queueCompleted[b.uid].success=e.status===200;d.queueCompleted[b.uid].result=e.status===200?JSON.parse(e.responseText):null;d._trigger("file_upload_finished",null,{queue:d.queueCompleted[b.uid]});if(Object.keys(d.queueUploading).length===0&&Object.keys(d.queueWaitList).length===0){d._trigger("done",null,{queue:d.queueCompleted});d.started=false;d.finished=true;d._calcTotal();d._calcTotalSent();d._totalPercentage=((d._totalSentSize/d._totalSize)*100).toFixed(2);d._trigger("progress",null,{sent:Object.keys(d.queueCompleted).length,total:Object.keys(d.queueCompleted).length,queue:d.queueUploading,percentage:d._totalPercentage,uploadSent:d._totalSentSize,uploadTotal:d._totalSize});d.queueWaitList={};d.queueCompleted={};d.queueUploading={}}});e.upload.addEventListener("progress",function(h){if(h.lengthComputable){d.queueUploading[b.uid].events=h;d.queueUploading[b.uid].file=b;var f=Object.keys(d.queueCompleted).length;var g=Object.keys(d.queueUploading).length;g+=Object.keys(d.queueWaitList).length;g+=f;b.uploadProgress=parseInt((h.loaded/h.total)*100);b.uploadSent=h.loaded;b.uploadTotal=h.total;d._trigger("file_progress",null,{sent:f,total:g,file:b});d._calcTotal();d._calcTotalSent();d._totalPercentage=((d._totalSentSize/d._totalSize)*100).toFixed(2);d._trigger("progress",null,{sent:f,total:g,queue:d.queueUploading,percentage:d._totalPercentage,uploadSent:d._totalSentSize,uploadTotal:d._totalSize})}},false);return e}})},_addFileToQueue:function(c){var b=this._getGUID();this.queueWaitList[b]={xhr:null,events:{},uid:b,file:c,size:c.size,uploadProgress:0,uploadSent:0,uploadTotal:0};this._trigger("file_add",null,{queue:this.queueWaitList[b]});if(this.options.autoUpload&&!this.started){this.start(this.queueWaitList)}},_proccessQueue:function(c){if(Object.keys(c.queueWaitList).length){if(c.options.limitConcurrentUploadRequests>Object.keys(c.queueUploading).length){var b=Object.keys(c.queueWaitList)[0];var d=c.queueWaitList[b];c.queueUploading[d.uid]=d;c.queueWaitList[b]=undefined;delete c.queueWaitList[b];c._uploadFile(d)}}else{clearInterval(c.queueIntervalId)}},start:function(){if(!this.started){this.started=true;this._trigger("started",null,null);var b=this;this.queueIntervalId=setInterval(function(){b._proccessQueue(b)},this.options.queueInterval)}},stop:function(){clearInterval(this.queueIntervalId);this.started=false;this._trigger("stopped",null,null);this.queueWaitList={};this.queueCompleted={};this.queueUploading={}},abortAll:function(){clearInterval(this.queueIntervalId);this.started=false;var b=this;a.each(this.queueUploading,function(c,d){d.xhr.abort();b._trigger("file_upload_aborted",null,{file:d})});this._trigger("aborted",null,{queue:this.queueUploading});this.queueWaitList={};this.queueCompleted={};this.queueUploading={};clearInterval(this.queueIntervalId)},_setOption:function(b,c){this.options[b]=c},_drag:function(b){b.stopPropagation();b.preventDefault()},_calcTotal:function(){var b=this;this._totalSize=0;a.each(this.queueUploading,function(c,d){b._totalSize+=d.size});a.each(this.queueCompleted,function(c,d){b._totalSize+=d.size});a.each(this.queueWaitList,function(c,d){b._totalSize+=d.size});return this._totalSize},_calcTotalSent:function(){var b=this;this._totalSentSize=0;a.each(this.queueUploading,function(c,d){if(parseInt(d.file.uploadSent)>0){b._totalSentSize+=d.file.uploadSent}});a.each(this.queueCompleted,function(c,d){b._totalSentSize+=d.file.uploadSent});return this._totalSentSize},_create:function(){this.url=window.URL||window.webkitURL;this.started=false;this.finished=false;this.queueUploading={};this.queueWaitList={};this.queueCompleted={};this.queueIntervalId=0;var b=this;if(this._fileInputSupport){a(this.element).change(function(c){b._validate(c.target.files||c.dataTransfer.files||c.originalEvent.dataTransfer.files)})}if(a(this.options.dropzone).length){a(this.options.dropzone).on("drag dragstart dragend dragover dragenter dragleave drop",b._drag).on("drop",function(c){b._validate(c.originalEvent.dataTransfer.files);return false})}},_destroy:function(){this.url=window.URL||window.webkitURL;this.started=false;this.finished=false;this.queueUploading={};this.queueWaitList={};this.queueCompleted={};this.queueIntervalId=0;delete this}})}));